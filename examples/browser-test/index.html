<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RC-Monitor 浏览器错误测试</title>
    <script src="http://github.com/xxxx.js"></script>
    <!-- 通过unpkg引入axios -->
    <script src="https://unpkg.com/axios@1.6.2/dist/axios.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .test-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
      }

      .test-section h3 {
        margin-top: 0;
        color: #555;
      }

      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background-color: #0056b3;
      }

      button.danger {
        background-color: #dc3545;
      }

      button.danger:hover {
        background-color: #c82333;
      }

      .console {
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .log-entry {
        margin: 5px 0;
        padding: 3px 0;
        border-bottom: 1px solid #333;
      }

      .log-error {
        color: #ff6b6b;
      }

      .log-info {
        color: #4ecdc4;
      }

      .log-success {
        color: #1dd1a1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>RC-Monitor 浏览器错误测试</h1>

      <div class="test-section">
        <h3>JavaScript 运行时错误测试</h3>
        <button onclick="testReferenceError()">触发 ReferenceError</button>
        <button onclick="testTypeError()">触发 TypeError</button>
        <button onclick="testSyntaxError()">触发 SyntaxError</button>
        <button onclick="testRangeError()">触发 RangeError</button>
      </div>

      <div class="test-section">
        <h3>网络错误</h3>
        <button onclick="testNetworkError()">触发 接口错误</button>
        <button onclick="testAxiosError()">触发 Axios 接口错误</button>
        <button onclick="testAxiosPromiseError()">触发 Axios Promise 未捕获错误</button>
      </div>

      <div class="test-section">
        <h3>Promise Rejection 测试</h3>
        <button onclick="testPromiseRejection()">触发 Promise Rejection</button>
        <button onclick="testAsyncError()">触发 Async/Await 错误</button>
      </div>

      <div class="test-section">
        <h3>自定义错误测试</h3>
        <button onclick="testCustomError()">触发自定义错误</button>
        <button onclick="testErrorWithStack()">触发带堆栈的错误</button>
      </div>

      <div class="test-section">
        <h3>事件监听器错误测试</h3>
        <button onclick="testEventListenerError()">触发事件监听器错误</button>
        <button onclick="testSetTimeoutError()">触发 setTimeout 错误</button>
      </div>

      <div class="console" id="console">
        <div class="log-entry log-info">控制台就绪，点击上方按钮测试错误监听功能...</div>
      </div>
    </div>

    <script src="../../packages/rc-monitor/dist/index.cjs"></script>
    <script src="../../packages/utils/dist/index.cjs"></script>
    <script src="../../packages/plugins/dist/index.cjs"></script>

    <script>
      const monitor = Monitor.getMonitor({
        appId: '123',
        endpoint: 'http://localhost:3000/api/error',
        reporterType: 'xhr',
      });

      monitor.use(new BrowserErrorPlugin());
      monitor.use(new BrowserBehaviorPlugin({ metrics: ['input'] }));
      monitor.use(new BrowserPerformancePlugin({ metrics: ['lcp', 'entries'] }));
      // 自定义控制台输出
      function logToConsole(message, type = 'info') {
        const consoleElement = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        consoleElement.appendChild(logEntry);
        consoleElement.scrollTop = consoleElement.scrollHeight;
      }

      function testNetworkError() {
        logToConsole('触发 接口错误...', 'info');
        // 测试1: 使用XHR但不处理错误，让它触发全局事件
        const xhr1 = new XMLHttpRequest();
        xhr1.open('POST', 'https://nonexistent-api.com/data1', true);
        xhr1.send(JSON.stringify({ name: 'test1' }));
      }

      // 使用axios测试网络请求错误
      function testAxiosError() {
        logToConsole('触发 Axios 接口错误...', 'info');
        // 有错误处理的axios请求
        axios
          .get('https://nonexistent-api.com/data')
          .then(function (response) {
            logToConsole('请求成功', 'success');
          })
          .catch(function (error) {
            logToConsole('Axios捕获到错误: ' + error.message, 'error');
            // 这里错误被处理了，不会触发全局unhandledrejection
          });
      }

      // 使用axios测试未捕获的Promise错误
      function testAxiosPromiseError() {
        logToConsole('触发 Axios Promise 未捕获错误...', 'info');
        // 没有错误处理的axios请求，应该触发全局unhandledrejection
        axios.get('https://nonexistent-api.com/data');
      }

      // 测试函数
      function testReferenceError() {
        logToConsole('触发 ReferenceError...', 'info');
        // 故意访问未定义的变量
        undefinedVariable.someMethod();
      }

      function testTypeError() {
        logToConsole('触发 TypeError...', 'info');
        // 对null调用方法
        const nullVar = null;
        nullVar.someMethod();
      }

      function testSyntaxError() {
        logToConsole('触发 SyntaxError...', 'info');
        // 语法错误
        eval('const x = ;');
      }

      function testRangeError() {
        logToConsole('触发 RangeError...', 'info');
        // 数组长度异常
        new Array(-1);
      }

      function testPromiseRejection() {
        logToConsole('触发 Promise Rejection...', 'info');
        // 未处理的Promise拒绝
        Promise.reject(new Error('这是一个Promise拒绝错误'));
      }

      async function testAsyncError() {
        logToConsole('触发 Async/Await 错误...', 'info');
        // async/await中的错误
        async function failingFunction() {
          throw new Error('Async函数中的错误');
        }

        failingFunction();
      }

      function testCustomError() {
        logToConsole('触发自定义错误...', 'info');
        // 自定义错误类
        class CustomError extends Error {
          constructor(message) {
            super(message);
            this.name = 'CustomError';
            this.customProperty = '自定义属性';
          }
        }

        throw new CustomError('这是一个自定义错误');
      }

      function testErrorWithStack() {
        logToConsole('触发带堆栈的错误...', 'info');
        // 创建带堆栈信息的错误
        function innerFunction() {
          throw new Error('内部函数错误');
        }

        function outerFunction() {
          innerFunction();
        }

        outerFunction();
      }

      function testEventListenerError() {
        logToConsole('触发事件监听器错误...', 'info');
        // 事件监听器中的错误
        const button = document.createElement('button');
        button.textContent = '点击触发错误';
        button.onclick = () => {
          throw new Error('事件监听器中的错误');
        };
        button.click();
      }

      function testSetTimeoutError() {
        logToConsole('触发 setTimeout 错误...', 'info');
        // setTimeout中的错误
        setTimeout(() => {
          throw new Error('setTimeout中的错误');
        }, 100);
      }

      // 监听监控器的报告事件
      //   monitor.on('report', (type, data) => {
      //     logToConsole(`监控器捕获到 ${type} 错误: ${data.message}`, 'success');
      //     console.log('错误详情:', data);
      //   });

      logToConsole('RC-Monitor 初始化完成，开始测试...', 'success');
    </script>
  </body>
</html>
